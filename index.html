<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S·∫°ch Mart - B·ªôt Gi·∫∑t Th√¥ng Minh</title>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    /* Header */
    header {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 20px 50px; 
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        position: sticky; 
        top: 0; 
        z-index: 100;
    }
    .logo { 
        font-size: 24px; 
        font-weight: 900; 
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    nav a { 
        margin: 0 15px; 
        text-decoration: none; 
        color: #333; 
        font-weight: 500; 
        transition: color 0.3s;
    }
    nav a:hover { color: #007bff; }
    
    /* Icons/Buttons */
    .header-icons { display: flex; align-items: center; gap: 15px; }
    .header-icons button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #333;
        transition: color 0.3s;
    }
    .header-icons button:hover { color: #007bff; }
    
    /* Cart Count */
    #cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #ff0000;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
    }
    .cart-icon-wrapper { position: relative; }

    /* Admin Controls */
    #admin-controls { 
        display: none; 
        align-items: center; 
        gap: 15px;
        margin-left: 20px; 
    }
    #admin-controls.active { display: flex; }
    
    /* User Profile Dropdown */
    .user-menu { position: relative; }
    .user-avatar {
        width: 40px;
        height: 40px;
        background: #007bff;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
    }
    #user-dropdown {
        position: absolute;
        top: 50px;
        right: 0;
        background: white;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        border-radius: 8px;
        width: 200px;
        padding: 10px;
        z-index: 1000;
        display: none;
        flex-direction: column;
        gap: 10px;
    }
    #user-dropdown.active { display: flex; }
    #user-info { display: none; align-items: center; gap: 10px; }
    .user-details { font-size: 14px; }
    .user-details div:last-child { color: #888; font-size: 12px; }
    
    /* Banner */
    .banner {
        text-align: center;
        padding: 100px 50px;
        background: url('https://picsum.photos/1200/400') center/cover; /* Placeholder. S·∫Ω ƒë·ªïi cho B·ªôt Gi·∫∑t */
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .banner h1 { font-size: 48px; margin-bottom: 15px; font-weight: 800; }
    .banner p { font-size: 20px; margin-bottom: 30px; }
    .btn-shop-now {
        background: #007bff;
        color: white;
        padding: 12px 30px;
        text-decoration: none;
        border-radius: 30px;
        font-weight: 600;
        transition: background-color 0.3s, transform 0.2s;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
    }
    .btn-shop-now:hover { background: #0056b3; transform: translateY(-2px); }

    /* Main Content */
    main { padding: 40px 50px; }
    .title { text-align: center; margin-bottom: 40px; font-size: 32px; color: #333; }

    /* Product List */
    #product-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
    }
    .product {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
    }
    .product:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .product-image-container { 
        width: 100%; 
        height: 200px; 
        overflow: hidden; 
    }
    .product-image-container img {
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        transition: transform 0.5s;
    }
    .product:hover img { transform: scale(1.05); }
    
    .product-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .product h3 { font-size: 18px; color: #333; margin-bottom: 8px; }
    .product-price { 
        font-size: 20px; 
        color: #ff5722; 
        font-weight: bold; 
        margin-bottom: 15px;
    }
    .product-actions { 
        display: flex; 
        gap: 10px;
        margin-top: 10px;
    }
    .product-actions button {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .view-detail { background: #e0e0e0; color: #333; }
    .view-detail:hover { background: #ccc; }

    /* Admin Mode */
    .admin-mode { cursor: default; }
    .admin-mode:hover { transform: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .admin-mode .view-detail { display: none; }
    .btn-delete-product { background: #ff4d4d; color: white; display: none; }
    .admin-mode .btn-delete-product { display: block; }
    .btn-delete-product:hover { background: #cc0000; }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        position: relative;
    }
    .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #888;
    }
    .modal h2 { margin-bottom: 20px; color: #333; }
    .modal input, .modal textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }
    .modal button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    .modal button:hover { background: #0056b3; }

    /* Detail Page */
    #detail-page {
        display: none;
        padding: 40px 50px;
    }
    .detail-container {
        display: flex;
        gap: 40px;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .detail-image { flex: 1; max-width: 50%; }
    .detail-image img { width: 100%; height: auto; border-radius: 8px; }
    .detail-info { flex: 1; }
    .detail-info h2 { font-size: 36px; margin-bottom: 10px; color: #007bff; }
    .detail-price { font-size: 30px; color: #ff5722; font-weight: bold; margin-bottom: 20px; }
    .detail-actions { display: flex; gap: 20px; margin-top: 30px; }
    .btn-add-cart, .btn-buy-now { 
        padding: 12px 25px; 
        font-size: 16px; 
        font-weight: 600; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        transition: transform 0.2s;
    }
    .btn-add-cart { background: #007bff; color: white; }
    .btn-buy-now { background: #ff5722; color: white; }
    .btn-add-cart:hover, .btn-buy-now:hover { transform: translateY(-1px); }
    .back-btn { 
        margin-top: 30px; 
        font-size: 16px; 
        color: #007bff; 
        cursor: pointer; 
        display: block; 
        width: fit-content;
    }
    
    /* Detail Specs */
    .specs-section { margin-top: 30px; }
    .specs-section h3 { margin-bottom: 10px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    #detail-specs { list-style: none; padding-left: 0; }
    #detail-specs li { margin-bottom: 5px; font-size: 15px; color: #555; }
    
    /* Cart Modal */
    #cart-modal .modal-content { max-width: 600px; }
    #cart-items { list-style: none; padding: 0; margin-bottom: 20px; max-height: 300px; overflow-y: auto; }
    .cart-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .cart-item-image { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
    .cart-item-info { flex-grow: 1; }
    .cart-item-name { font-weight: 600; }
    .cart-item-price { color: #ff5722; font-size: 14px; }
    .cart-item-remove { 
        background: #f4f4f4; 
        color: #888; 
        padding: 5px 10px; 
        border-radius: 5px; 
        transition: background-color 0.3s;
    }
    .cart-item-remove:hover { background: #ffdddd; color: #cc0000; }
    .cart-total-info { 
        display: flex; 
        justify-content: space-between; 
        font-size: 20px; 
        font-weight: bold; 
        margin-top: 15px; 
        border-top: 1px solid #ddd; 
        padding-top: 15px;
    }
    .checkout-btn-area { text-align: right; margin-top: 20px; }
    
    /* Add Product Modal */
    #add-product-modal textarea { height: 80px; }
    #image-preview { 
        max-width: 100%; 
        max-height: 100px; 
        object-fit: contain; 
        margin-bottom: 15px; 
        border: 1px dashed #ddd; 
        padding: 5px; 
        border-radius: 5px;
        display: none;
    }
    #product-specs { min-height: 100px; }

    /* Footer */
    footer {
        text-align: center;
        padding: 30px 50px;
        background: #333;
        color: white;
        margin-top: 40px;
    }
</style>

</head>
<body>

<header>
    <div class="logo">S·∫°ch Mart</div>
    <nav>
        <a href="#" onclick="showHome()">Trang Ch·ªß</a>
        <a href="#product-list">S·∫£n Ph·∫©m</a>
    </nav>
    <div class="header-icons">
        <div id="admin-controls">
            <button onclick="showAddProductModal()">‚ú® Th√™m SP</button>
        </div>
        <div class="cart-icon-wrapper">
            <button onclick="showCart()">
                üõí Gi·ªè H√†ng (<span id="cart-count">0</span>)
            </button>
        </div>
        <button id="login-btn" onclick="showLoginModal()">ƒêƒÉng Nh·∫≠p</button>
        <div class="user-menu" id="user-info">
            <div class="user-avatar" onclick="toggleUserMenu()">
                <span id="user-initial">A</span>
            </div>
            <div class="user-dropdown" id="user-dropdown">
                <div class="user-details">
                    <div>Ch√†o, <span id="user-name-display">Admin</span></div>
                    <div id="user-role-display">Qu·∫£n tr·ªã vi√™n</div>
                </div>
                <button onclick="logout()">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </div>
</header>

<main id="home-page">
    
<section class="banner">
    <h1>S·ª©c M·∫°nh L√†m S·∫°ch T·ªëi ∆Øu Cho M·ªçi Gia ƒê√¨nh</h1>
    <p>B·ªôt gi·∫∑t th·∫ø h·ªá m·ªõi: ƒê√°nh bay m·ªçi v·∫øt b·∫©n c·ª©ng ƒë·∫ßu, l∆∞u h∆∞∆°ng d√†i l√¢u.</p>
    <a href="#product-list" class="btn-shop-now">Kh√°m ph√° ngay</a>
</section>

    <h2 class="title" id="product-list">S·∫£n Ph·∫©m N·ªïi B·∫≠t</h2>
    <div id="product-list">
        </div>
</main>

<section id="detail-page">
    <a href="#" class="back-btn" onclick="showHome()">‚Üê Quay l·∫°i Trang Ch·ªß</a>
    <div class="detail-container">
        <div class="detail-image">
            <img id="detail-img" src="" alt="Product Image">
        </div>
        <div class="detail-info">
            <h2 id="detail-name"></h2>
            <p class="detail-price" id="detail-price"></p>
            <p id="detail-desc"></p>
            
            <div class="specs-section">
                <h3>Th√¥ng s·ªë/Th√†nh ph·∫ßn</h3>
                <ul id="detail-specs">
                    </ul>
            </div>
            
            <div class="detail-actions">
                <button class="btn-add-cart btn-add-cart" onclick="addToCartFromDetail()">Th√™m v√†o gi·ªè</button>
                <button class="btn-buy-now" onclick="buyNow()">Mua Ngay</button>
            </div>
        </div>
    </div>
</section>

<footer>
    <p>&copy; 2023 S·∫°ch Mart. C√¥ng Ngh·ªá S·∫°ch Cho Cu·ªôc S·ªëng Xanh.</p>
</footer>

<div id="login-modal" class="modal" onclick="closeModalOnOutside(event, 'login-modal')">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('login-modal')">&times;</span>
        <h2>ƒêƒÉng Nh·∫≠p Admin</h2>
        <input type="email" id="login-email" placeholder="Email (admin@shop.com)">
        <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u (admin123)">
        <button onclick="login()">ƒêƒÉng Nh·∫≠p</button>
    </div>
</div>

<div id="add-product-modal" class="modal" onclick="closeModalOnOutside(event, 'add-product-modal')">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('add-product-modal')">&times;</span>
        <h2>Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
        <input type="text" id="product-name" placeholder="T√™n s·∫£n ph·∫©m">
        <input type="number" id="product-price" placeholder="Gi√° (VD: 190000)">
        <input type="url" id="product-image" placeholder="URL h√¨nh ·∫£nh (VD: https://...)">
        <input type="file" id="product-image-file" accept="image/*" onchange="previewImage(event)">
        <img id="image-preview" src="" style="display:none;" alt="Preview">
        <textarea id="product-desc" placeholder="M√¥ t·∫£ chi ti·∫øt"></textarea>
        <textarea id="product-specs" placeholder="Th√¥ng s·ªë/Th√†nh ph·∫ßn (M·ªói d√≤ng m·ªôt m·ª•c)"></textarea>
        <button onclick="addProduct()">Th√™m S·∫£n Ph·∫©m</button>
    </div>
</div>

<div id="cart-modal" class="modal" onclick="closeModalOnOutside(event, 'cart-modal')">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('cart-modal')">&times;</span>
        <h2>üõí Gi·ªè H√†ng C·ªßa B·∫°n</h2>
        <ul id="cart-items">
            </ul>
        <div class="order-form-area">
            <h3>Th√¥ng tin giao h√†ng</h3>
            <input type="text" id="order-name" placeholder="H·ªç t√™n ng∆∞·ªùi nh·∫≠n">
            <input type="tel" id="order-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
            <input type="text" id="order-address" placeholder="ƒê·ªãa ch·ªâ giao h√†ng">
        </div>
        <div class="cart-total-info">
            <span>T·ªïng c·ªông:</span>
            <span><span id="cart-total">0</span>‚Ç´</span>
        </div>
        <div class="checkout-btn-area">
            <button onclick="checkout()">Thanh To√°n</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// 1. C·∫§U H√åNH FIREBASE
// ============================================================
const firebaseConfig = {
    apiKey: "AIzaSyAXDfcxcZyPvoNRDcYK70oFtfm1fQfpYwQ", 
    authDomain: "shopmart-2dc9d.firebaseapp.com", 
    databaseURL: "https://shopmart-2dc9d-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "shopmart-2dc9d", 
    storageBucket: "shopmart-2dc9d.firebasestorage.app",
    messagingSenderId: "107122177579",
    appId: "1:107122177579:web:531735163351335b37e0c4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================================
// C√ÅC BI·∫æN TO√ÄN C·ª§C
// ============================================================
let cart = [];
let currentProduct = null;
let currentUser = null;
let products = []; 

const accounts = {
    'admin@shop.com': { password: 'admin123', name: 'Admin', role: 'admin' },
    'user@shop.com': { password: 'user123', name: 'User', role: 'user' }
};

// =========================================================
// 2. CH·ª®C NƒÇNG L·∫§Y V√Ä HI·ªÇN TH·ªä S·∫¢N PH·∫®M
// =========================================================

async function loadProducts() {
    try {
        const productsRef = db.collection('products').orderBy('id');
        const snapshot = await productsRef.get();
        
        products = snapshot.docs.map(doc => ({
            id: doc.id, 
            ...doc.data()
        }));
        
        displayProducts();
    } catch (error) {
        console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m t·ª´ Firebase:", error);
    }
}

// Hi·ªÉn th·ªã s·∫£n ph·∫©m (ƒê√É FIX L·ªñI C√ö PH√ÅP ONCLICK V√Ä GI√Å)
function displayProducts() {
    const productList = document.getElementById('product-list');
    const isAdmin = currentUser && currentUser.role === 'admin';
    
    productList.innerHTML = products.map(product => `
        <div class="product ${isAdmin ? 'admin-mode' : ''}" 
             onclick="${isAdmin ? '' : `showProductDetail('${product.id}')`}"> 
            
            <div class="product-image-container">
                <img src="${product.image}" alt="${product.name}">
            </div>
            <div class="product-content">
                <h3>${product.name}</h3>
                <p class="product-price">${product.price.toLocaleString('vi-VN')}‚Ç´</p> 
                <div class="product-actions">
                    <button class="view-detail" onclick="event.stopPropagation(); showProductDetail('${product.id}')">
                        Xem chi ti·∫øt
                    </button>
                    <button class="btn-delete-product" onclick="event.stopPropagation(); deleteProduct('${product.id}')">
                        üóëÔ∏è X√≥a
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m (ƒê√É FIX L·ªñI N·∫∂NG: X·ª≠ l√Ω m·∫£ng 'specs' an to√†n)
function showProductDetail(productId) {
    currentProduct = products.find(p => p.id == productId); 
    if (!currentProduct) return;
    
    document.getElementById('home-page').style.display = 'none';
    document.getElementById('detail-page').style.display = 'block';
    
    document.getElementById('detail-img').src = currentProduct.image;
    document.getElementById('detail-name').textContent = currentProduct.name;
    document.getElementById('detail-price').textContent = currentProduct.price.toLocaleString('vi-VN') + '‚Ç´';
    document.getElementById('detail-desc').textContent = currentProduct.description;
    
    const specsList = document.getElementById('detail-specs');
    // FIX L·ªñI: ƒê·∫£m b·∫£o specs l√† m·∫£ng ƒë·ªÉ tr√°nh l·ªói .map is not a function
    const specsArray = Array.isArray(currentProduct.specs) ? currentProduct.specs : [];
    specsList.innerHTML = specsArray.map(spec => `<li>‚Ä¢ ${spec}</li>`).join('');
    
    window.scrollTo(0, 0);
}


// =========================================================
// 3. CH·ª®C NƒÇNG TH√äM S·∫¢N PH·∫®M
// =========================================================

async function addProduct() {
    const name = document.getElementById('product-name').value.trim();
    const price = parseInt(document.getElementById('product-price').value);
    const image = document.getElementById('product-image').value.trim();
    const desc = document.getElementById('product-desc').value.trim();
    const specsText = document.getElementById('product-specs').value.trim();
    
    if (!name || !price || !image || !desc || !specsText) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }
    
    const specs = specsText.split('\n').filter(s => s.trim());
    
    const newProductData = {
        name: name,
        price: price,
        image: image,
        description: desc,
        specs: specs,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
        id: Date.now() 
    };
    
    try {
        await db.collection('products').add(newProductData);
        
        closeModal('add-product-modal');
        alert(`‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m th√†nh c√¥ng!`);
        
        loadProducts();
    } catch (error) {
        console.error("L·ªói khi th√™m s·∫£n ph·∫©m:", error);
        alert('L·ªói: Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m.');
    }
}


// =========================================================
// 4. CH·ª®C NƒÇNG X√ìA S·∫¢N PH·∫®M (ƒê√É T·ªêI ∆ØU H√ìA)
// =========================================================

async function deleteProduct(productId) {
    // 1. Ki·ªÉm tra quy·ªÅn Admin
    if (!currentUser || currentUser.role !== 'admin') {
        alert('‚ùå B·∫°n c·∫ßn quy·ªÅn Admin ƒë·ªÉ x√≥a s·∫£n ph·∫©m!');
        return;
    }

    // 2. Hi·ªán h·ªôp tho·∫°i x√°c nh·∫≠n
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        try {
            // Th·ª±c hi·ªán x√≥a t·ª´ Firestore
            await db.collection('products').doc(productId).delete();
            
            alert('‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
            loadProducts();
        } catch (error) {
            // B√°o l·ªói chi ti·∫øt ƒë·ªÉ ng∆∞·ªùi d√πng ki·ªÉm tra Rules
            console.error("L·ªñI X√ìA FIREBASE:", error);
            alert('L·ªñI X√ìA S·∫¢N PH·∫®M: Vi·ªác x√≥a th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra 1. K·∫øt n·ªëi m·∫°ng v√† 2. Firebase Rules c·ªßa b·∫°n.');
        }
    }
}


// =========================================================
// 5. C√ÅC CH·ª®C NƒÇNG KH√ÅC
// =========================================================

function showHome() {
    document.getElementById('home-page').style.display = 'block';
    document.getElementById('detail-page').style.display = 'none';
    window.scrollTo(0, 0);
}

function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u!');
        return;
    }
    
    const account = accounts[email];
    
    if (!account || account.password !== password) {
        alert('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
        return;
    }
    
    currentUser = { email: email, name: account.name, role: account.role };
    
    // C·∫≠p nh·∫≠t giao di·ªán
    document.getElementById('login-btn').style.display = 'none';
    document.getElementById('user-info').style.display = 'flex';
    document.getElementById('user-initial').textContent = account.name.charAt(0);
    document.getElementById('user-name-display').textContent = account.name;
    document.getElementById('user-role-display').textContent = account.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ng∆∞·ªùi d√πng';
    
    if (account.role === 'admin') {
        document.getElementById('admin-controls').classList.add('active');
    }
    
    closeModal('login-modal');
    loadProducts();
    
    alert(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng!\nCh√†o m·ª´ng ${account.name}${account.role === 'admin' ? ' - Qu·∫£n tr·ªã vi√™n' : ''}!`);
}

function logout() {
    currentUser = null;
    document.getElementById('login-btn').style.display = 'block';
    document.getElementById('user-info').style.display = 'none';
    document.getElementById('admin-controls').classList.remove('active');
    document.getElementById('user-dropdown').classList.remove('active');
    
    loadProducts();
    alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
}

function toggleUserMenu() {
    document.getElementById('user-dropdown').classList.toggle('active');
}

function showLoginModal() {
    document.getElementById('login-modal').classList.add('active');
    document.getElementById('login-email').value = '';
    document.getElementById('login-password').value = '';
}

function showAddProductModal() {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin ƒë·ªÉ th√™m s·∫£n ph·∫©m!');
        return;
    }
    document.getElementById('add-product-modal').classList.add('active');
    document.getElementById('product-name').value = '';
    document.getElementById('product-price').value = '';
    document.getElementById('product-image').value = '';
    document.getElementById('product-image-file').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('product-desc').value = '';
    document.getElementById('product-specs').value = '';
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('product-image').value = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function addToCartFromDetail() {
    if (!currentProduct) return;
    
    cart.push({
        id: currentProduct.id,
        name: currentProduct.name,
        price: currentProduct.price,
        image: currentProduct.image
    });
    
    updateCartCount();
    alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
}

function buyNow() {
    if (!currentProduct) return;
    addToCartFromDetail();
    showCart();
}

function updateCartCount() {
    document.getElementById('cart-count').textContent = cart.length;
}

function showCart() {
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<div class="empty-cart">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</div>';
        cartTotal.textContent = '0';
    } else {
        let total = 0;
        cartItems.innerHTML = cart.map((item, index) => {
            total += item.price;
            return `
                <li class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString('vi-VN')}‚Ç´</div>
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart(${index})">X√≥a</button>
                </li>
            `;
        }).join('');
        cartTotal.textContent = total.toLocaleString('vi-VN');
    }
    
    document.getElementById('cart-modal').classList.add('active');
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartCount();
    showCart();
}

// Thanh to√°n (ƒê√É S·ª¨A: L∆∞u ƒë∆°n h√†ng v√†o Firestore)
async function checkout() {
    if (cart.length === 0) {
        alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
        return;
    }
    
    const orderName = document.getElementById('order-name').value.trim();
    const orderPhone = document.getElementById('order-phone').value.trim();
    const orderAddress = document.getElementById('order-address').value.trim();

    if (!orderName || !orderPhone || !orderAddress) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng: H·ªç t√™n, S·ªë ƒëi·ªán tho·∫°i v√† ƒê·ªãa ch·ªâ!');
        return;
    }

    const total = cart.reduce((sum, item) => sum + item.price, 0);
    
    const orderData = {
        userId: currentUser ? currentUser.email : 'Guest', 
        userName: orderName,
        userPhone: orderPhone,
        userAddress: orderAddress,
        items: cart,
        totalAmount: total,
        orderDate: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'Pending'
    };
    
    try {
        const docRef = await db.collection('orders').add(orderData);
        
        alert(`‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u.\n\nT·ªïng ƒë∆°n h√†ng: ${total.toLocaleString('vi-VN')}‚Ç´\nID ƒë∆°n h√†ng: ${docRef.id}`);
        
        cart = [];
        updateCartCount();
        document.getElementById('order-name').value = '';
        document.getElementById('order-phone').value = '';
        document.getElementById('order-address').value = '';
        closeModal('cart-modal');
        
    } catch (error) {
        console.error("L·ªói khi l∆∞u ƒë∆°n h√†ng v√†o Firebase:", error);
        alert('L·ªói: Kh√¥ng th·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function closeModalOnOutside(event, modalId) {
    if (event.target.id === modalId) {
        closeModal(modalId);
    }
}

document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('user-dropdown');
    if (userMenu && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

loadProducts();
updateCartCount();
</script>
</body>
</html>
