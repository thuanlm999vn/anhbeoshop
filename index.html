<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WashMaster - M√°y Gi·∫∑t Th√¥ng Minh</title>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    /* Header */
    header {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 20px 50px; 
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        position: sticky; 
        top: 0; 
        z-index: 100;
    }
    .logo { 
        font-size: 24px; 
        font-weight: 900; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: pointer;
    }
    nav a {
        margin-left: 25px;
        text-decoration: none;
        color: #333;
        font-weight: 600;
        transition: color 0.3s;
    }
    nav a:hover { color: #667eea; }

    /* Icons */
    .icon-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .cart-icon, .user-menu {
        position: relative;
        cursor: pointer;
        font-size: 24px;
        color: #333;
        transition: color 0.3s;
    }
    .cart-icon:hover, .user-menu:hover { color: #667eea; }
    
    .cart-count {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ff5252;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: bold;
    }
    
    /* User Menu */
    #user-info {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω hi·ªán khi ƒëƒÉng nh·∫≠p */
        align-items: center;
        gap: 10px;
    }
    .user-initial {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        position: relative;
    }
    .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        border-radius: 8px;
        overflow: hidden;
        z-index: 10;
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
    }
    .user-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .user-dropdown-info {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    .user-dropdown-info div {
        font-size: 14px;
        color: #555;
    }
    .user-dropdown-info strong {
        display: block;
        font-size: 16px;
        color: #333;
        margin-bottom: 5px;
    }
    .user-dropdown button {
        width: 100%;
        padding: 10px 15px;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 15px;
    }
    .user-dropdown button:hover {
        background: #f1f1f1;
    }

    /* Admin Controls */
    #admin-controls {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        margin-right: 20px;
    }
    #admin-controls.active {
        display: block;
    }
    .btn-admin {
        padding: 10px 15px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
        font-weight: 600;
    }
    .btn-admin:hover {
        background: #45a049;
    }

    /* Banner - ƒê√£ s·ª≠a cho M√°y Gi·∫∑t */
    .banner {
        text-align: center;
        padding: 100px 50px;
        /* S·ª≠ d·ª•ng h√¨nh ·∫£nh m√°y gi·∫∑t l√†m n·ªÅn */
        background: 
            linear-gradient(rgba(30, 60, 114, 0.7), rgba(42, 82, 152, 0.7)), /* Overlay t·ªëi m√†u */
            url('image_6b685b.jpg') no-repeat center center; /* ·∫¢nh n·ªÅn */
        background-size: cover;
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin-bottom: 30px;
    }
    .banner h1 {
        font-size: 48px;
        margin-bottom: 15px;
        font-weight: 900;
    }
    .banner p {
        font-size: 20px;
        margin-bottom: 30px;
        max-width: 600px;
    }
    .btn-shop-now {
        padding: 15px 30px;
        background: #ff5252;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        transition: background 0.3s, transform 0.2s;
    }
    .btn-shop-now:hover {
        background: #e04a4a;
        transform: translateY(-2px);
    }

    /* Product List */
    main {
        padding: 20px 50px;
    }
    h2 {
        text-align: center;
        margin-bottom: 40px;
        font-size: 32px;
        color: #333;
        position: relative;
    }
    h2::after {
        content: '';
        display: block;
        width: 60px;
        height: 4px;
        background: #667eea;
        margin: 10px auto 0;
        border-radius: 2px;
    }
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        padding-bottom: 50px;
    }
    .product {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }
    .product:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .product-image-container {
        height: 200px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .product img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }
    .product:hover img {
        transform: scale(1.05);
    }
    .product-content {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .product h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: #333;
        min-height: 45px;
    }
    .product-price {
        font-size: 22px;
        color: #ff5252;
        font-weight: bold;
        margin-top: auto; /* ƒê·∫©y gi√° xu·ªëng d∆∞·ªõi */
        margin-bottom: 15px;
    }
    .product-actions {
        display: flex;
        gap: 10px;
    }
    .product-actions button {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s, color 0.3s;
        flex-grow: 1;
    }
    .product-actions .view-detail {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    .product-actions .view-detail:hover {
        background: #556ee6;
    }
    
    /* Delete Button for Admin */
    .btn-delete-product {
        background: #f44336;
        color: white;
        border-color: #f44336;
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
    }
    .product.admin-mode .view-detail {
        display: none;
    }
    .product.admin-mode .btn-delete-product {
        display: block; /* Hi·ªán khi ·ªü ch·∫ø ƒë·ªô Admin */
        flex-grow: 1;
    }
    .product.admin-mode .btn-delete-product:hover {
        background: #e53935;
    }

    /* Detail Page */
    #detail-page {
        display: none;
        padding: 50px;
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-top: 30px;
    }
    .detail-container {
        display: flex;
        gap: 40px;
    }
    .detail-image-area {
        flex: 1;
        max-width: 50%;
    }
    .detail-image-area img {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .detail-content-area {
        flex: 1;
    }
    #detail-name {
        font-size: 36px;
        color: #333;
        margin-bottom: 10px;
    }
    #detail-price {
        font-size: 30px;
        color: #ff5252;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .detail-actions button {
        padding: 15px 25px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s;
        margin-right: 15px;
    }
    .detail-actions .btn-buy {
        background: #667eea;
        color: white;
    }
    .detail-actions .btn-buy:hover { background: #556ee6; }
    .detail-actions .btn-back {
        background: #ccc;
        color: #333;
    }
    .detail-actions .btn-back:hover { background: #bbb; }
    
    .detail-specs-section, .detail-desc-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .detail-desc-section h3, .detail-specs-section h3 {
        font-size: 22px;
        color: #333;
        margin-bottom: 10px;
    }
    #detail-desc {
        line-height: 1.6;
        color: #555;
    }
    #detail-specs {
        list-style: none;
        padding-left: 0;
    }
    #detail-specs li {
        padding: 5px 0;
        color: #555;
        border-bottom: 1px dotted #eee;
    }

    /* Modal Styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 200;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .modal.active .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    .modal-content h3 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
    }
    .modal-content label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
    }
    .modal-content input[type="email"], 
    .modal-content input[type="password"],
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }
    .modal-content textarea {
        resize: vertical;
        min-height: 100px;
    }
    .modal-content button {
        width: 100%;
        padding: 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        transition: background 0.3s;
    }
    .modal-content button:hover {
        background: #556ee6;
    }
    .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #888;
        transition: color 0.2s;
    }
    .close-btn:hover { color: #333; }

    /* Cart Modal */
    #cart-modal .modal-content {
        max-width: 600px;
    }
    #cart-items {
        list-style: none;
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    .cart-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .cart-item-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 4px;
    }
    .cart-item-info {
        flex-grow: 1;
    }
    .cart-item-name {
        font-weight: 600;
        font-size: 15px;
    }
    .cart-item-price {
        color: #ff5252;
        font-size: 14px;
    }
    .cart-item-remove {
        background: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .empty-cart {
        text-align: center;
        padding: 30px;
        color: #888;
    }
    .cart-total-section {
        display: flex;
        justify-content: space-between;
        font-size: 18px;
        font-weight: bold;
        padding-top: 15px;
        border-top: 2px solid #667eea;
        margin-bottom: 20px;
    }
    .cart-total-section span:last-child {
        color: #ff5252;
    }
    
    /* Order Form */
    .order-form-group {
        margin-bottom: 15px;
    }
    
    /* Image Preview */
    #image-preview {
        max-width: 100%;
        height: auto;
        display: none;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
    }

    /* Footer */
    footer {
        text-align: center;
        padding: 20px 50px;
        margin-top: 30px;
        background: #333;
        color: white;
        font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        header, main, footer {
            padding: 15px 20px;
        }
        .banner {
            padding: 60px 20px;
        }
        .banner h1 {
            font-size: 32px;
        }
        .banner p {
            font-size: 16px;
        }
        .detail-container {
            flex-direction: column;
        }
        .detail-image-area {
            max-width: 100%;
        }
    }
</style>
</head>
<body>

    <header>
        <div class="logo" onclick="showHome()">WashMaster</div>
        <nav>
            <a href="#product-list">S·∫£n Ph·∫©m</a>
            <a href="#">Gi·ªõi Thi·ªáu</a>
        </nav>
        <div class="icon-container">
            <div id="admin-controls">
                <button class="btn-admin" onclick="showAddProductModal()">+ Th√™m SP</button>
            </div>
            
            <div class="cart-icon" onclick="showCart()">
                üõí
                <span class="cart-count" id="cart-count">0</span>
            </div>

            <button id="login-btn" class="btn-admin" onclick="showLoginModal()">ƒêƒÉng Nh·∫≠p</button>

            <div class="user-menu" id="user-info">
                <div class="user-initial" onclick="toggleUserMenu()" id="user-initial">A</div>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-dropdown-info">
                        <strong id="user-name-display">Admin</strong>
                        <div id="user-role-display">Qu·∫£n tr·ªã vi√™n</div>
                    </div>
                    <button onclick="logout()">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </div>
    </header>

    <div id="home-page">
        <section class="banner">
            <h1>C√¥ng Ngh·ªá Gi·∫∑t Gi≈© Th√¥ng Minh Cho Gia ƒê√¨nh Hi·ªán ƒê·∫°i</h1>
            <p>Tr·∫£i nghi·ªám m√°y gi·∫∑t th·∫ø h·ªá m·ªõi: Gi·∫∑t s·∫°ch ho√†n h·∫£o, ti·∫øt ki·ªám ƒëi·ªán n∆∞·ªõc.</p>
            <a href="#product-list" class="btn-shop-now">Kh√°m ph√° ngay</a>
        </section>

        <main>
            <h2 id="product-list-title">S·∫¢N PH·∫®M M√ÅY GI·∫∂T N·ªîI B·∫¨T</h2>
            <div class="product-grid" id="product-list">
                </div>
        </main>
    </div>

    <div id="detail-page">
        <div class="detail-container">
            <div class="detail-image-area">
                <img id="detail-img" src="" alt="Product Image">
            </div>
            <div class="detail-content-area">
                <h1 id="detail-name">T√™n S·∫£n Ph·∫©m</h1>
                <p id="detail-price" class="product-price"></p>
                <div class="detail-actions">
                    <button class="btn-buy" onclick="addToCartFromDetail()">Th√™m v√†o gi·ªè</button>
                    <button class="btn-buy" onclick="buyNow()">Mua ngay</button>
                    <button class="btn-back" onclick="showHome()">Quay l·∫°i</button>
                </div>
                
                <div class="detail-desc-section">
                    <h3>M√¥ t·∫£ s·∫£n ph·∫©m</h3>
                    <p id="detail-desc"></p>
                </div>
                
                <div class="detail-specs-section">
                    <h3>Th√¥ng s·ªë k·ªπ thu·∫≠t</h3>
                    <ul id="detail-specs">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <footer>
        &copy; 2025 WashMaster. All rights reserved. Thi·∫øt k·∫ø b·ªüi Gemini AI.
    </footer>

    <div id="login-modal" class="modal" onclick="closeModalOnOutside(event, 'login-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('login-modal')">&times;</span>
            <h3>ƒêƒÉng Nh·∫≠p</h3>
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" value="admin@shop.com">
            <label for="login-password">M·∫≠t kh·∫©u:</label>
            <input type="password" id="login-password" value="admin123">
            <button onclick="login()">ƒêƒÉng Nh·∫≠p</button>
            <p style="margin-top: 15px; font-size: 14px; color: #555;">T√†i kho·∫£n Admin: admin@shop.com / admin123</p>
        </div>
    </div>

    <div id="add-product-modal" class="modal" onclick="closeModalOnOutside(event, 'add-product-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('add-product-modal')">&times;</span>
            <h3>Th√™m S·∫£n Ph·∫©m M·ªõi</h3>
            
            <label for="product-name">T√™n S·∫£n Ph·∫©m:</label>
            <input type="text" id="product-name">
            
            <label for="product-price">Gi√° (VNƒê):</label>
            <input type="number" id="product-price">
            
            <label for="product-image">URL ·∫¢nh ho·∫∑c T·∫£i l√™n:</label>
            <input type="text" id="product-image" placeholder="D√°n URL ·∫£nh v√†o ƒë√¢y">
            <input type="file" id="product-image-file" accept="image/*" onchange="previewImage(event)">
            <img id="image-preview" alt="Image Preview">

            <label for="product-desc">M√¥ t·∫£:</label>
            <textarea id="product-desc"></textarea>
            
            <label for="product-specs">Th√¥ng s·ªë k·ªπ thu·∫≠t (M·ªói d√≤ng 1 th√¥ng s·ªë):</label>
            <textarea id="product-specs"></textarea>
            
            <button onclick="addProduct()">Th√™m S·∫£n Ph·∫©m</button>
        </div>
    </div>

    <div id="cart-modal" class="modal" onclick="closeModalOnOutside(event, 'cart-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cart-modal')">&times;</span>
            <h3>Gi·ªè H√†ng C·ªßa B·∫°n</h3>
            
            <ul id="cart-items">
                </ul>

            <div class="order-form-group">
                <label for="order-name">H·ªç t√™n ng∆∞·ªùi nh·∫≠n:</label>
                <input type="text" id="order-name" placeholder="Nguy·ªÖn VƒÉn A">
                <label for="order-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="text" id="order-phone" placeholder="09xxxxxxxx">
                <label for="order-address">ƒê·ªãa ch·ªâ giao h√†ng:</label>
                <textarea id="order-address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..."></textarea>
            </div>
            
            <div class="cart-total-section">
                <span>T·ªïng c·ªông:</span>
                <span id="cart-total">0</span>‚Ç´
            </div>
            
            <button onclick="checkout()">Thanh To√°n</button>
        </div>
    </div>

<script>
// ============================================================
// 1. C·∫§U H√åNH FIREBASE
// ============================================================
const firebaseConfig = {
    // THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N
    apiKey: "AIzaSyAXDfcxcZyPvoNRDcYK70oFtfm1fQfpYwQ", 
    authDomain: "shopmart-2dc9d.firebaseapp.com", 
    databaseURL: "https://shopmart-2dc9d-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "shopmart-2dc9d", 
    storageBucket: "shopmart-2dc9d.firebasestorage.app",
    messagingSenderId: "107122177579",
    appId: "1:107122177579:web:531735163351335b37e0c4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================================
// C√ÅC BI·∫æN TO√ÄN C·ª§C
// ============================================================
let cart = [];
let currentProduct = null;
let currentUser = null; // S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ localStorage
let products = []; 

const accounts = {
    'admin@shop.com': { password: 'admin123', name: 'Admin', role: 'admin' },
    'user@shop.com': { password: 'user123', name: 'User', role: 'user' }
};

// =========================================================
// 2. H√ÄM QU·∫¢N L√ù PHI√äN (FIX L·ªñI F5 ƒêƒÇNG XU·∫§T V√Ä ADMIN CHECK)
// =========================================================

// H√†m qu·∫£n l√Ω hi·ªÉn th·ªã UI/Admin Controls
function updateUIForUser(user) {
    if (user) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('user-initial').textContent = user.name.charAt(0);
        document.getElementById('user-name-display').textContent = user.name;
        document.getElementById('user-role-display').textContent = user.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 'Ng∆∞·ªùi d√πng';
        
        if (user.role === 'admin') {
            document.getElementById('admin-controls').classList.add('active');
        } else {
            document.getElementById('admin-controls').classList.remove('active');
        }
    } else {
        document.getElementById('login-btn').style.display = 'block';
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('admin-controls').classList.remove('active');
        document.getElementById('user-dropdown').classList.remove('active');
    }
    // C·∫ßn t·∫£i l·∫°i s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t X√≥a (hi·ªán/·∫©n)
    loadProducts(); 
}

// üîë ƒêƒÉng nh·∫≠p (L∆∞u v√†o LocalStorage)
function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß email v√† m·∫≠t kh·∫©u!');
        return;
    }
    
    const account = accounts[email];
    
    if (!account || account.password !== password) {
        alert('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
        return;
    }
    
    currentUser = { email: email, name: account.name, role: account.role };
    
    // üî• QUAN TR·ªåNG: L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√†o LocalStorage
    localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
    
    closeModal('login-modal');
    updateUIForUser(currentUser);
    
    alert(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng!\nCh√†o m·ª´ng ${account.name}${account.role === 'admin' ? ' - Qu·∫£n tr·ªã vi√™n' : ''}!`);
}

// üîë ƒêƒÉng xu·∫•t (X√≥a kh·ªèi LocalStorage)
function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser'); // üî• QUAN TR·ªåNG: X√≥a tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    updateUIForUser(currentUser);
    alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
}

// üîë Kh√¥i ph·ª•c phi√™n l√†m vi·ªác khi t·∫£i l·∫°i trang
function restoreSession() {
    const userJson = localStorage.getItem('currentUser');
    if (userJson) {
        currentUser = JSON.parse(userJson);
        updateUIForUser(currentUser);
    } else {
        updateUIForUser(null);
    }
}


// =========================================================
// 3. CH·ª®C NƒÇNG L·∫§Y V√Ä HI·ªÇN TH·ªä S·∫¢N PH·∫®M (ƒê·∫£m b·∫£o l·∫•y Document ID)
// =========================================================

async function loadProducts() {
    try {
        const productsRef = db.collection('products').orderBy('id');
        const snapshot = await productsRef.get();
        
        products = snapshot.docs.map(doc => ({
            // ƒê·∫£m b·∫£o l·∫•y ID CHU·ªñI (doc.id) c·ªßa Firestore ƒë·ªÉ x√≥a
            id: doc.id, 
            ...doc.data()
        }));
        
        displayProducts();
    } catch (error) {
        console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m t·ª´ Firebase:", error);
    }
}

// Hi·ªÉn th·ªã s·∫£n ph·∫©m
function displayProducts() {
    const productList = document.getElementById('product-list');
    const isAdmin = currentUser && currentUser.role === 'admin';
    
    productList.innerHTML = products.map(product => `
        <div class="product ${isAdmin ? 'admin-mode' : ''}" 
             onclick="${isAdmin ? '' : `showProductDetail('${product.id}')`}"> 
            
            <div class="product-image-container">
                <img src="${product.image}" alt="${product.name}">
            </div>
            <div class="product-content">
                <h3>${product.name}</h3>
                <p class="product-price">${product.price.toLocaleString('vi-VN')}‚Ç´</p> 
                <div class="product-actions">
                    <button class="view-detail" onclick="event.stopPropagation(); showProductDetail('${product.id}')">
                        Xem chi ti·∫øt
                    </button>
                    <button class="btn-delete-product" onclick="event.stopPropagation(); deleteProduct('${product.id}')">
                        üóëÔ∏è X√≥a
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m
function showProductDetail(productId) {
    // FIX L·ªñI: T√¨m s·∫£n ph·∫©m d·ª±a tr√™n Document ID (chu·ªói)
    currentProduct = products.find(p => p.id === productId); 
    if (!currentProduct) return;
    
    document.getElementById('home-page').style.display = 'none';
    document.getElementById('detail-page').style.display = 'block';
    
    document.getElementById('detail-img').src = currentProduct.image;
    document.getElementById('detail-name').textContent = currentProduct.name;
    document.getElementById('detail-price').textContent = currentProduct.price.toLocaleString('vi-VN') + '‚Ç´';
    document.getElementById('detail-desc').textContent = currentProduct.description;
    
    const specsList = document.getElementById('detail-specs');
    const specsArray = Array.isArray(currentProduct.specs) ? currentProduct.specs : [];
    specsList.innerHTML = specsArray.map(spec => `<li>‚Ä¢ ${spec}</li>`).join('');
    
    window.scrollTo(0, 0);
}


// =========================================================
// 4. CH·ª®C NƒÇNG TH√äM S·∫¢N PH·∫®M
// =========================================================

async function addProduct() {
    const name = document.getElementById('product-name').value.trim();
    const price = parseInt(document.getElementById('product-price').value);
    const image = document.getElementById('product-image').value.trim();
    const desc = document.getElementById('product-desc').value.trim();
    const specsText = document.getElementById('product-specs').value.trim();
    
    if (!name || !price || !image || !desc || !specsText) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }
    
    const specs = specsText.split('\n').filter(s => s.trim());
    
    const newProductData = {
        name: name,
        price: price,
        image: image,
        description: desc,
        specs: specs,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
        id: Date.now() 
    };
    
    try {
        await db.collection('products').add(newProductData);
        
        closeModal('add-product-modal');
        alert(`‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m th√†nh c√¥ng!`);
        
        loadProducts();
    } catch (error) {
        console.error("L·ªói khi th√™m s·∫£n ph·∫©m:", error);
        alert('L·ªói: Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m.');
    }
}


// =========================================================
// 5. CH·ª®C NƒÇNG X√ìA S·∫¢N PH·∫®M (FIX L·ªñI ADMIN CHECK V√Ä LOG CHI TI·∫æT)
// =========================================================

async function deleteProduct(productId) {
    // Ki·ªÉm tra quy·ªÅn Admin ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c t·ª´ localStorage
    if (!currentUser || currentUser.role !== 'admin') {
        alert('‚ùå B·∫°n c·∫ßn quy·ªÅn Admin ƒë·ªÉ x√≥a s·∫£n ph·∫©m!');
        return;
    }

    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        try {
            console.log("ID ƒëang c·ªë g·∫Øng x√≥a:", productId); 
            
            // üî• L·ªánh x√≥a b·∫±ng Document ID (chu·ªói)
            await db.collection('products').doc(productId).delete();
            
            alert('‚úÖ ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
            loadProducts();
        } catch (error) {
            console.error("üî¥ L·ªñI X√ìA FIREBASE:", error);
            // D√π ƒë√£ x√°c ƒë·ªãnh Rules ƒë√∫ng, v·∫´n ƒë·ªÉ c·∫£nh b√°o n·∫øu Firebase tr·∫£ v·ªÅ l·ªói
            if (error.code === 'permission-denied') {
                alert('üî¥ L·ªñI: Quy·ªÅn truy c·∫≠p b·ªã t·ª´ ch·ªëi. Vui l√≤ng ki·ªÉm tra v√† PUBLISH Rules tr√™n Firebase Console.');
            } else {
                alert(`L·ªñI X√ìA KH√ÅC: ${error.message}. Vui l√≤ng xem Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.`);
            }
        }
    }
}


// =========================================================
// 6. C√ÅC CH·ª®C NƒÇNG KH√ÅC 
// =========================================================

function showHome() {
    document.getElementById('home-page').style.display = 'block';
    document.getElementById('detail-page').style.display = 'none';
    window.scrollTo(0, 0);
}

function toggleUserMenu() {
    document.getElementById('user-dropdown').classList.toggle('active');
}

function showLoginModal() {
    document.getElementById('login-modal').classList.add('active');
    document.getElementById('login-email').value = 'admin@shop.com';
    document.getElementById('login-password').value = 'admin123';
}

function showAddProductModal() {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin ƒë·ªÉ th√™m s·∫£n ph·∫©m!');
        return;
    }
    document.getElementById('add-product-modal').classList.add('active');
    document.getElementById('product-name').value = '';
    document.getElementById('product-price').value = '';
    document.getElementById('product-image').value = '';
    document.getElementById('product-image-file').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('product-desc').value = '';
    document.getElementById('product-specs').value = '';
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('product-image').value = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function addToCartFromDetail() {
    if (!currentProduct) return;
    
    cart.push({
        id: currentProduct.id,
        name: currentProduct.name,
        price: currentProduct.price,
        image: currentProduct.image
    });
    
    updateCartCount();
    alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
}

function buyNow() {
    if (!currentProduct) return;
    addToCartFromDetail();
    showCart();
}

function updateCartCount() {
    document.getElementById('cart-count').textContent = cart.length;
}

function showCart() {
    const cartItems = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<div class="empty-cart">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</div>';
        cartTotal.textContent = '0';
    } else {
        let total = 0;
        cartItems.innerHTML = cart.map((item, index) => {
            total += item.price;
            return `
                <li class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString('vi-VN')}‚Ç´</div>
                    </div>
                    <button class="cart-item-remove" onclick="removeFromCart(${index})">X√≥a</button>
                </li>
            `;
        }).join('');
        cartTotal.textContent = total.toLocaleString('vi-VN');
    }
    
    document.getElementById('cart-modal').classList.add('active');
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartCount();
    showCart();
}

async function checkout() {
    if (cart.length === 0) {
        alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng!');
        return;
    }
    
    const orderName = document.getElementById('order-name').value.trim();
    const orderPhone = document.getElementById('order-phone').value.trim();
    const orderAddress = document.getElementById('order-address').value.trim();

    if (!orderName || !orderPhone || !orderAddress) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng: H·ªç t√™n, S·ªë ƒëi·ªán tho·∫°i v√† ƒê·ªãa ch·ªâ!');
        return;
    }

    const total = cart.reduce((sum, item) => sum + item.price, 0);
    
    const orderData = {
        userId: currentUser ? currentUser.email : 'Guest', 
        userName: orderName,
        userPhone: orderPhone,
        userAddress: orderAddress,
        items: cart,
        totalAmount: total,
        orderDate: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'Pending'
    };
    
    try {
        const docRef = await db.collection('orders').add(orderData);
        
        alert(`‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u.\n\nT·ªïng ƒë∆°n h√†ng: ${total.toLocaleString('vi-VN')}‚Ç´\nID ƒë∆°n h√†ng: ${docRef.id}`);
        
        cart = [];
        updateCartCount();
        document.getElementById('order-name').value = '';
        document.getElementById('order-phone').value = '';
        document.getElementById('order-address').value = '';
        closeModal('cart-modal');
        
    } catch (error) {
        console.error("L·ªói khi l∆∞u ƒë∆°n h√†ng v√†o Firebase:", error);
        alert('L·ªói: Kh√¥ng th·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function closeModalOnOutside(event, modalId) {
    if (event.target.id === modalId) {
        closeModal(modalId);
    }
}

document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('user-dropdown');
    if (userMenu && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

// üî• G·ªåI H√ÄM KH√îI PH·ª§C PHI√äN L√ÄM VI·ªÜC KHI TRANG T·∫¢I XONG
restoreSession(); 
// loadProducts() v√† updateUI ƒë∆∞·ª£c g·ªçi trong restoreSession()
updateCartCount();

</script>
</body>
</html>
